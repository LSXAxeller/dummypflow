<UserControl
    x:Class="ProseFlow.UI.Views.Providers.ProvidersView"
    xmlns="https://github.com/avaloniaui"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:shadui="clr-namespace:ShadUI;assembly=ShadUI"
    xmlns:vm="using:ProseFlow.UI.ViewModels.Providers"
    x:DataType="vm:ProvidersViewModel">

    <DockPanel LastChildFill="True">

        <!-- Page Header -->
        <StackPanel Margin="48,24" DockPanel.Dock="Top" Spacing="4">
            <TextBlock Classes="h2" Text="AI Providers" />
            <TextBlock
                Classes="p"
                Text="Configure your AI models, both cloud-based and local."
                TextWrapping="Wrap" />
        </StackPanel>

        <!-- Footer with Save Button -->
        <Border
            DockPanel.Dock="Bottom"
            Padding="16"
            BorderBrush="{DynamicResource BorderColor}"
            BorderThickness="0,1,0,0">
            <Button
                Classes="Primary"
                Command="{Binding SaveCommand}"
                HorizontalAlignment="Right">
                <shadui:ButtonAssist.Icon>
                    <TextBlock Classes="LucideIcon" Text="" />
                </shadui:ButtonAssist.Icon>
                Save Provider Settings
            </Button>
        </Border>

        <!-- Scrollable Main Content -->
        <ScrollViewer>
            <StackPanel Margin="48,0,48,24" Spacing="32">

                <!-- Card 1: Cloud Provider Fallback Chain -->
                <shadui:Card HasShadow="True">
                    <shadui:Card.Header>
                        <DockPanel>
                            <Button Classes="Primary" DockPanel.Dock="Right" VerticalAlignment="Top" Command="{Binding AddProviderCommand}">
                                <shadui:ButtonAssist.Icon>
                                    <TextBlock Classes="LucideIcon" Text="" />
                                </shadui:ButtonAssist.Icon>
                                Add Provider
                            </Button>
                            <StackPanel Orientation="Horizontal" Spacing="12">
                                <TextBlock Classes="LucideIcon h3" Text="" />
                                <StackPanel>
                                    <shadui:CardTitle>Cloud Provider Fallback Chain</shadui:CardTitle>
                                    <shadui:CardDescription>Add and reorder providers. They will be tried from top to bottom.</shadui:CardDescription>
                                </StackPanel>
                            </StackPanel>
                        </DockPanel>
                    </shadui:Card.Header>
                    <DataGrid
                        AutoGenerateColumns="False"
                        CanUserReorderColumns="False" CanUserResizeColumns="True" CanUserSortColumns="False"
                        GridLinesVisibility="Horizontal" IsReadOnly="True"
                        ItemsSource="{Binding CloudProviders}">
                        <!-- TODO: Add Drag and Drop for reordering -->
                        <DataGrid.Columns>
                            <DataGridTextColumn Width="*" Binding="{Binding Name}" Header="Configuration Name" />
                            <DataGridTextColumn Width="150" Binding="{Binding IsEnabled}" Header="Enabled" />
                            <DataGridTextColumn Width="150" Binding="{Binding ProviderType}" Header="Provider" />
                            <DataGridTextColumn Width="200" Binding="{Binding Model}" Header="Model" />
                            <DataGridTemplateColumn Width="100" Header="Actions">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <StackPanel Orientation="Horizontal" Spacing="4" HorizontalAlignment="Center">
                                            <Button Classes="Icon Ghost" ToolTip.Tip="Edit Provider" Command="{Binding $parent[UserControl].((vm:ProvidersViewModel)DataContext).EditProviderCommand}" CommandParameter="{Binding .}">
                                                <TextBlock Classes="LucideIcon" Text=""/>
                                            </Button>
                                            <Button Classes="Icon Ghost Destructive" ToolTip.Tip="Delete Provider" Command="{Binding $parent[UserControl].((vm:ProvidersViewModel)DataContext).DeleteProviderCommand}" CommandParameter="{Binding .}">
                                                <TextBlock Classes="LucideIcon" Text=""/>
                                            </Button>
                                        </StackPanel>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                        </DataGrid.Columns>
                    </DataGrid>
                </shadui:Card>
                
                <!-- Local Provider Settings -->
                <shadui:Card HasShadow="True">
                    <shadui:Card.Header>
                        <StackPanel Orientation="Horizontal" Spacing="12">
                            <TextBlock Classes="LucideIcon h3" Text="" />
                            <StackPanel>
                                <shadui:CardTitle>Local Provider</shadui:CardTitle>
                                <shadui:CardDescription>Run models locally on your machine (via LlamaEdge).</shadui:CardDescription>
                            </StackPanel>
                        </StackPanel>
                    </shadui:Card.Header>
                    <StackPanel>
                        <!-- A banner to indicate placeholder status -->
                        <Border
                            Margin="0,0,0,16"
                            Padding="12"
                            Background="{DynamicResource InfoColor10}"
                            BorderBrush="{DynamicResource InfoColor20}"
                            BorderThickness="1"
                            CornerRadius="{DynamicResource LgCornerRadius}">
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <TextBlock Classes="LucideIcon" Text="" Foreground="{DynamicResource InfoColor}" />
                                <TextBlock Classes="Small Muted" VerticalAlignment="Center"
                                           Text="Local model support is coming soon." />
                            </StackPanel>
                        </Border>
                        <StackPanel Spacing="16" IsEnabled="False">
                            <Grid ColumnDefinitions="*, Auto" ColumnSpacing="8">
                                <TextBox
                                    shadui:ControlAssist.Label="Model Path (.gguf)"
                                    Text="{Binding Settings.LocalModelPath, FallbackValue=''}" />
                                <Button
                                    Grid.Column="1"
                                    VerticalAlignment="Bottom"
                                    Content="Browse..." />
                            </Grid>
                            <ToggleSwitch IsChecked="{Binding Settings.PreferGpu, FallbackValue={x:False}}" Margin="10,0,0,0">
                                Prefer GPU acceleration (if available)
                            </ToggleSwitch>
                        </StackPanel>
                    </StackPanel>
                </shadui:Card>
                
                <!-- Provider Switching Logic -->
                <shadui:Card HasShadow="True">
                    <shadui:Card.Header>
                        <StackPanel Orientation="Horizontal" Spacing="12">
                            <TextBlock Classes="LucideIcon h3" Text="" />
                            <StackPanel>
                                <shadui:CardTitle>Service Type Logic</shadui:CardTitle>
                                <shadui:CardDescription>Configure the high-level fallback between Cloud and Local services.</shadui:CardDescription>
                            </StackPanel>
                        </StackPanel>
                    </shadui:Card.Header>
                    <StackPanel Spacing="16">
                        <ComboBox
                            shadui:ControlAssist.Label="Primary Service Type"
                            shadui:ControlAssist.Hint="The default service to use for all actions."
                            ItemsSource="{Binding AvailableServiceTypes}"
                            SelectedItem="{Binding Settings.PrimaryServiceType, FallbackValue=''}" />
                        <ComboBox
                            shadui:ControlAssist.Label="Fallback Service Type"
                            shadui:ControlAssist.Hint="Used if the primary service type is unavailable."
                            ItemsSource="{Binding AvailableFallbackServiceTypes}"
                            SelectedItem="{Binding Settings.FallbackServiceType, FallbackValue=''}" />
                    </StackPanel>
                </shadui:Card>
            </StackPanel>
        </ScrollViewer>
    </DockPanel>
</UserControl>