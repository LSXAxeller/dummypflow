<UserControl x:Class="ProseFlow.UI.Views.Dashboard.OverviewDashboardView"
             xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:shadui="clr-namespace:ShadUI;assembly=ShadUI"
             xmlns:vm="using:ProseFlow.UI.ViewModels.Dashboard"
             xmlns:local="clr-namespace:ProseFlow.Infrastructure.Services.AiProviders.Local;assembly=ProseFlow.Infrastructure"
             xmlns:controls="using:ProseFlow.UI.Controls.Dashboard"
             xmlns:avalonia="clr-namespace:LiveChartsCore.SkiaSharpView.Avalonia;assembly=LiveChartsCore.SkiaSharpView.Avalonia"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="600"
             x:DataType="vm:OverviewDashboardView">
    <DockPanel LastChildFill="True">
        <ComboBox DockPanel.Dock="Top" HorizontalAlignment="Right" Margin="0,0,0,16"
                  ItemsSource="{Binding DateRanges}" SelectedItem="{Binding SelectedDateRange}" Width="200" />
                  
        <ScrollViewer>
            <StackPanel Spacing="16">
                <!-- KPI Cards -->
                <UniformGrid Columns="3" ColumnSpacing="16">
                    <controls:OverviewCard Title="Total Actions" Value="{Binding TotalActionsExecuted, StringFormat='N0'}" Icon="{StaticResource IconActions}" />
                    <controls:OverviewCard Title="Cloud Tokens" Value="{Binding TotalCloudTokens, StringFormat='N0'}" Icon="{StaticResource IconCloud}" />
                    <controls:OverviewCard Title="Local Tokens" Value="{Binding TotalLocalTokens, StringFormat='N0'}" Icon="{StaticResource IconComputer}" />
                </UniformGrid>
                
                <!-- Main Grid -->
                <Grid ColumnDefinitions="2*, 1*" ColumnSpacing="16">
                    <!-- Left: Chart -->
                    <shadui:Card>
                        <shadui:Card.Header><shadui:CardTitle>Usage Over Time</shadui:CardTitle></shadui:Card.Header>
                        <avalonia:CartesianChart Series="{Binding UsageSeries}" XAxes="{Binding XAxes}" Height="300" Margin="12,0,12,12" />
                    </shadui:Card>
                    
                    <!-- Status & Recents -->
                    <StackPanel Grid.Column="1" Spacing="16">
                        <shadui:Card>
                            <shadui:Card.Header><shadui:CardTitle>Local Model</shadui:CardTitle></shadui:Card.Header>
                            <StackPanel Spacing="8">
                                <Grid ColumnDefinitions="Auto, *" ColumnSpacing="8">
                                    <Ellipse Width="10" Height="10" VerticalAlignment="Center"
                                             Fill="{Binding LocalModelStatus, Converter={StaticResource StatusToColorConverter}}" />
                                    <TextBlock Grid.Column="1" Text="{Binding LocalModelStatus}" />
                                </Grid>
                                <TextBlock Text="{Binding LocalModelName}" Classes="Muted Small" />
                            </StackPanel>
                            <shadui:Card.Footer>
                                <Button Classes="Primary" HorizontalAlignment="Stretch" Command="{Binding ToggleLocalModelCommand}"
                                        Content="{Binding LocalModelStatus, Converter={StaticResource StatusToButtonTextConverter}}"
                                        IsEnabled="{Binding LocalModelStatus, Converter={x:Static ObjectConverters.NotEqual}, ConverterParameter={x:Static local:ModelStatus.Loading}}" />
                            </shadui:Card.Footer>
                        </shadui:Card>
                        
                        <shadui:Card>
                            <shadui:Card.Header><shadui:CardTitle>Recent Activity</shadui:CardTitle></shadui:Card.Header>
                            <ItemsControl ItemsSource="{Binding RecentActivity}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Grid ColumnDefinitions="*, Auto" Margin="0,6">
                                            <TextBlock Text="{Binding ActionName}" />
                                            <TextBlock Grid.Column="1" Text="{Binding Timestamp, Converter={StaticResource RelativeTimeConverter}}" Classes="Small Muted" />
                                        </Grid>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </shadui:Card>
                    </StackPanel>
                </Grid>
            </StackPanel>
        </ScrollViewer>
    </DockPanel>
</UserControl>